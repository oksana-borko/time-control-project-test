# Time Control API

Web API для контроля рабочего времени в малом бизнесе. Система позволяет управлять сотрудниками, отслеживать рабочие смены, управлять ролями и контролировать доступ к различным функциям.

## Введение

Time Control API - это RESTful веб-сервис, разработанный для автоматизации учета рабочего времени сотрудников. Система предоставляет функционал для:

- Управления учетными записями сотрудников (найм, увольнение, редактирование)
- Контроля рабочих смен (начало/конец, перерывы, коррекция)
- Ролевой системы доступа
- Аутентификации и авторизации
- Ведения логов и мониторинга

### Технологический стек

- **Node.js** с **TypeScript**
- **Express.js** - веб-фреймворк
- **MongoDB** с **Mongoose** - база данных
- **JWT** - аутентификация
- **Joi** - валидация данных
- **bcrypt** - хеширование паролей
- **Winston** - логирование
- **Jest** - тестирование
- **Swagger** - документация API

## Запуск проекта

### Предварительные требования

- Node.js (версия 18+)
- MongoDB (локальная установка или облачная база)
- npm или yarn

### Установка зависимостей

```bash
npm install
```

### Конфигурация окружения

Создайте файл `.env` в корневой директории проекта:

```env
# Подключение к базе данных MongoDB
MONGO_URI=mongodb://localhost:27017/time_control_db
# Для MongoDB Atlas:
# MONGO_URI=mongodb+srv://username:password@cluster.mongodb.net/time_control_db

# JWT настройки
JWT_SECRET=your-super-secret-jwt-key-here-make-it-long-and-complex
JWT_EXP=24h

# Настройки логирования (опционально)
LOG_LEVEL=info
```

**Обязательные переменные окружения:**
- `MONGO_URI` - строка подключения к MongoDB
- `JWT_SECRET` - секретный ключ для JWT токенов (рекомендуется использовать сложный ключ длиной 32+ символа)
- `JWT_EXP` - время жизни JWT токена (например: "1h", "24h", "7d")

### Запуск приложения

```bash
# Разработка
npm start

# Тестирование
npm test
```

Приложение будет доступно по адресу: `http://localhost:3555`

API документация (Swagger): `http://localhost:3555/docs`

## Секьюрити

### Аутентификация

Система использует JWT (JSON Web Tokens) для аутентификации пользователей. После успешной аутентификации клиент получает токен, который должен передаваться в заголовке `Authorization`:

```
Authorization: Bearer <your-jwt-token>
```

### Авторизация и роли

Система поддерживает ролевую модель доступа с следующими ролями:

1. **crew** - обычный сотрудник
2. **manager** - менеджер
3. **hr** - HR специалист
4. **supervisor** - супервайзер (высшие права доступа)

### Правила доступа к эндпоинтам

| Эндпоинт | Роли | Описание |
|----------|------|----------|
| `GET /accounts/reader_id` | user, admin, premium | Получение данных сотрудника |
| `PATCH /accounts/password` | user, premium | Изменение пароля |
| `DELETE /accounts` | super | Увольнение сотрудника |
| `PATCH /accounts` | user, admin, premium | Обновление данных сотрудника |
| `PUT /accounts/roles` | super | Изменение ролей |

### Безопасные эндпоинты

Следующие эндпоинты не требуют аутентификации:
- `POST /accounts` - регистрация новых сотрудников
- `POST /accounts/login` - аутентификация

### Валидация данных

- Все входящие данные проходят валидацию с помощью Joi схем
- Пароли хешируются с использованием bcrypt (сложность: 10)
- ID сотрудников должны быть длиной 9 символов
- Пароли должны содержать минимум 8 символов (только буквы и цифры)

### Защита от атак

- Проверка временных интервалов между сменами (минимум 8 часов)
- Контроль состояния смен (невозможно начать новую смену, не закрыв предыдущую)
- Проверка на повторный найм уволенных сотрудников
- Логирование всех операций для аудита

## Описание эндпоинтов

### Управление сотрудниками (`/accounts`)

#### `POST /accounts` - Найм сотрудника
- **Доступ**: публичный
- **Тело запроса**:
  ```json
  {
    "firstName": "Иван",
    "lastName": "Петров",
    "password": "password123",
    "id": "123456789"
  }
  ```
- **Ответ**: данные созданного сотрудника с табельным номером и хешем

#### `GET /accounts` - Список всех сотрудников
- **Доступ**: любая роль
- **Ответ**: массив сотрудников

#### `GET /accounts/pages` - Список с пагинацией
- **Доступ**: любая роль
- **Параметры**: `page`, `limit`
- **Ответ**: данные с пагинацией

#### `GET /accounts/employee` - Получить сотрудника по ID
- **Доступ**: user, admin, premium
- **Параметры**: `id` (query)
- **Ответ**: данные сотрудника

#### `PATCH /accounts` - Обновить данные сотрудника
- **Доступ**: user, admin, premium
- **Параметры**: `id` (query)
- **Тело запроса**:
  ```json
  {
    "firstName": "Новое имя",
    "lastName": "Новая фамилия"
  }
  ```

#### `PATCH /accounts/password` - Изменить пароль
- **Доступ**: user, premium
- **Тело запроса**:
  ```json
  {
    "id": "123456789",
    "newPassword": "newpass123"
  }
  ```

#### `PATCH /accounts/set_role` - Установить роль
- **Доступ**: super
- **Параметры**: `id` (query)
- **Тело запроса**:
  ```json
  {
    "role": "manager"
  }
  ```

#### `DELETE /accounts` - Уволить сотрудника
- **Доступ**: super
- **Пара